#!/usr/bin/env ruby
#
# shodan_ips.py
# Search SHODAN and print a list of IPs matching the query
#
# Author: achillean
$:.unshift File.dirname(__FILE__)

require 'rubygems'
require 'shodan'

# Configuration
API_KEY = "eMLZhC7qt42If0U8ndfZTlCWSSxFYass"

# Input validation
if ARGV.length == 0
        puts "Usage: ./shodan_ips.rb <search query>"
        exit 1
end

begin
        # Setup the API
        api = Shodan::Shodan.new(API_KEY)

        # Perform the search
        query = ARGV.join(" ")

        puts "\n--- shodan.exploits.search ---"
        result = api.exploits.search(query, :page => 2, :facets => 'author')

        # Loop through the matches and print the IPs
        puts "Total: #{result['total']}"
        result['matches'][0..10].each{ |exploit|
                puts exploit
        }

        puts result['facets']

        puts "\n--- shodan.exploits.search ---"
        result = api.exploits.count(query, :facets => 'author')

        # Loop through the matches and print the IPs
        puts "Total: #{result['total']}"
        result['matches'][0..10].each{ |exploit|
                puts exploit
        }

        puts result['facets']
rescue Exception => e
        puts "Error: #{e.to_s}"
        exit 1
end
